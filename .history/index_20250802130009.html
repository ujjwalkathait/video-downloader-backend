document.getElementById("download-form").addEventListener("submit", async function (e) {
  e.preventDefault();

  const url = document.getElementById("url-input").value.trim();
  const errorMessage = document.getElementById("error-message");
  const loader = document.getElementById("loader");
  const resultsSection = document.getElementById("results-section");
  const videoTitle = document.getElementById("video-title");
  const videoThumbnail = document.getElementById("video-thumbnail");
  const downloadLinks = document.getElementById("download-links");

  errorMessage.classList.add("hidden");
  resultsSection.classList.add("hidden");
  loader.classList.remove("hidden");

  try {
    const response = await fetch(`index.php?url=${encodeURIComponent(url)}`);
    const data = await response.json();
    loader.classList.add("hidden");

    if (!data.success) {
      errorMessage.textContent = data.error || "Something went wrong.";
      errorMessage.classList.remove("hidden");
      return;
    }

    // Show result section
    resultsSection.classList.remove("hidden");
    videoTitle.textContent = data.title || "Untitled";
    videoThumbnail.src = data.thumbnail || "";

    downloadLinks.innerHTML = "";

    // Filter to only valid URLs (audio+video or video only)
    const filteredItems = data.items
      .filter((item) => item.url && item.vcodec !== "none")
      .slice(0, 5); // limit to top 5

    if (filteredItems.length === 0) {
      downloadLinks.innerHTML = "<p>No downloadable content found.</p>";
      return;
    }

    filteredItems.forEach((item, index) => {
      const btn = document.createElement("a");
      btn.href = item.url;
      btn.target = "_blank";
      btn.download = true;
      btn.className =
        "inline-block px-4 py-2 bg-blue-600 text-white font-semibold rounded hover:bg-blue-700 transition";
      btn.textContent = `Download ${item.resolution || item.type || "Video"} (${index + 1})`;
      downloadLinks.appendChild(btn);
    });
  } catch (err) {
    loader.classList.add("hidden");
    errorMessage.textContent = "Error fetching video data.";
    errorMessage.classList.remove("hidden");
  }
});
